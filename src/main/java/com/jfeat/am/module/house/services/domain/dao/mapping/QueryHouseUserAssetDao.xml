<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.house.services.domain.dao.QueryHouseUserAssetDao">
    <sql id="Base_Column_List">
        t_house_user_asset
        .
        id
        ,
        t_house_user_asset.user_id AS userId,
        t_house_user_asset.asset_id AS assetId,
        t_house_user_asset.trust AS trust,
        t_house_user_asset.create_time AS createTime,
        t_house_user_asset.note AS note,
        t_house_user_asset.final_flag AS finalFlag,

        t_house_asset.house_number AS roomNumber,
        t_house_asset.floor AS floor,

        t_house_property_community.id AS communityId,
        t_house_property_community.community As communityName,
        t_house_property_community.address AS address,

        t_house_property_building.id As buildingId,
        t_house_property_building.area AS buildingArea,
        t_house_property_building.code AS buildingCode,
        t_house_property_building_unit.id AS unitId,
        t_house_property_building_unit.direction AS direction,

        t_house_design_model.area AS unitArea,
        t_house_design_model.house_type AS houseType,
       t_house_design_model.house_type_picture AS houseTypePicture,

        t_house_vr_picture.link AS vrLink,
        t_house_vr_picture.snapshot AS vrSnapshot,

        t_end_user.name AS userName,
        t_end_user.phone AS userPhone,
        t_end_user.avatar AS userAvatar
    </sql>


    <select id="queryMasterModel" resultType="HouseUserAssetModel">
        SELECT t_house_user_asset.*,
               t_house_property_community.id            AS communityId,
               t_house_property_community.community     As communityName,
               t_house_property_community.address       AS address,

               t_house_property_building.id             As buildingId,
               t_house_property_building.area           AS buildingArea,
               t_house_property_building.code           AS buildingCode,

               t_house_property_building_unit.id        AS unitId,
               t_house_property_building_unit.direction AS direction,

               t_house_design_model.area                AS unitArea,
               t_house_design_model.house_type          AS houseType,
               t_house_design_model.house_type_picture  AS houseTypePicture,
               t_house_vr_picture.link                  AS vrLink,
               t_house_vr_picture.snapshot              AS vrSnapshot,

               t_house_asset.number                     AS roomNumber,
               t_house_asset.floor                      AS floor,

               t_end_user.name                          AS userName,
               t_end_user.phone                         AS userPhone,
               t_end_user.avatar                        AS userAvatar

        FROM t_house_user_asset
                 JOIN t_house_asset ON t_house_asset.id = t_house_user_asset.asset_id
                 JOIN t_house_property_building ON t_house_property_building.id = t_house_asset.building_id
                 JOIN t_house_property_community
                      ON t_house_property_community.id = t_house_property_building.community_id
                 JOIN t_house_property_building_unit ON t_house_property_building_unit.id = t_house_asset.unit_id
                 left JOIN t_house_design_model
                           ON t_house_property_building_unit.design_model_id = t_house_design_model.id
                 left join t_house_vr_picture on t_house_vr_picture.id = t_house_design_model.vr_id
                 JOIN t_end_user ON t_end_user.id = t_house_user_asset.user_id
        WHERE t_house_user_asset.id = #{id}
        GROUP BY t_house_user_asset.id
    </select>


    <select id="findHouseUserAssetPage" resultType="HouseUserAssetRecord" parameterType="HouseUserAssetRecord">
        SELECT
        <include refid="Base_Column_List"/>


        FROM t_house_user_asset

        JOIN t_house_asset ON t_house_asset.id = t_house_user_asset.asset_id
        JOIN t_house_property_building ON t_house_property_building.id = t_house_asset.building_id
        JOIN t_house_property_community ON t_house_property_community.id=t_house_property_building.community_id
        left JOIN t_house_property_building_unit ON t_house_property_building_unit.id = t_house_asset.unit_id
        left JOIN t_house_design_model ON t_house_property_building_unit.design_model_id=t_house_design_model.id
        left join t_house_vr_picture on t_house_vr_picture.id = t_house_design_model.vr_id
        JOIN t_end_user ON t_end_user.id = t_house_user_asset.user_id
        <if test="communityId !=null and communityId>0">
            where t_house_property_community.id = #{communityId}
        </if>

        <if test="communityId ==null">
            WHERE 1=1
        </if>




        <if test="record.id != null and record.id>0 ">
            AND t_house_user_asset.id LIKE CONCAT('%',#{record.id},'%')
        </if>

        <if test="record.orgId != null and record.orgId>0 ">
            AND t_house_property_community.tenant_id = #{record.orgId}
        </if>


        <if test="record.userId != null and record.userId>0 ">
            AND t_house_user_asset.user_id LIKE CONCAT('%',#{record.userId},'%')
        </if>


        <if test="record.assetId != null and record.assetId>0 ">
            AND t_house_user_asset.asset_id LIKE CONCAT('%',#{record.assetId},'%')
        </if>

        <if test="record.note != null and record.note!= ''">
            AND t_house_user_asset.note LIKE CONCAT('%',#{record.note},'%')
        </if>


        <if test="record.createTime != null and record.createTime>0 ">
            AND t_house_user_asset.create_time LIKE CONCAT('%',#{record.createTime},'%')
        </if>


        <if test="record.username != null and record.username!='' ">
            AND t_end_user.name LIKE CONCAT('%',#{record.username},'%')
        </if>
        <if test="record.userPhone != null and record.userPhone!='' ">
            AND t_end_user.phone LIKE CONCAT('%',#{record.userPhone},'%')
        </if>

        <if test="startTime != null">
            <![CDATA[AND t_house_user_asset.start_time >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_house_user_asset.end_time <= DATE(#{endTime}]]>
        </if>

        <if test="search != null and search != ''">

            AND (
            t_house_property_community.community LIKE CONCAT('%',#{search},'%')
            OR t_house_property_building.code LIKE CONCAT('%',#{search},'%')
            OR t_house_design_model.house_type LIKE CONCAT('%',#{search},'%')
            OR t_house_asset.number LIKE CONCAT('%',#{search},'%')
            Or t_end_user.phone LIKE CONCAT('%',#{record.userPhone},'%')
            OR t_end_user.name LIKE CONCAT('%',#{record.username},'%')
            )
        </if>
        ORDER BY t_house_user_asset.user_id

    </select>


    <update id="updateUserAssetByUserIdAndAsset">
        UPDATE t_house_user_asset
        <trim prefix="set" suffixOverrides=",">
            <if test="entity.assetId!=null">asset_id=#{entity.assetId},</if>
            <if test="entity.userId!=null">user_id=#{entity.userId},</if>
            <if test="entity.rentStatus!=null">rent_status=#{entity.rentStatus},</if>


            <if test="entity.rentTitle!=null">rent_title=#{entity.rentTitle},</if>
            <if test="entity.rentPrice!=null">rent_price=#{entity.rentPrice},</if>
            <if test="entity.rentDescribe!=null">rent_describe=#{entity.rentDescribe},</if>
            <if test="entity.slideshow!=null">slideshow=#{entity.slideshow},</if>
            <if test="entity.rentTime!=null">rent_time=#{entity.rentTime},</if>


            <if test="entity.createTime!=null">create_time=#{entity.createTime},</if>
            <if test="entity.rentTime!=null">rent_time=#{entity.rentTime},</if>
            <if test="entity.note!=null">note=#{entity.note},</if>
        </trim>
        where t_house_user_asset.asset_id=#{assetId} AND t_house_user_asset.user_id=#{userId}
    </update>


    <update id="updateClashAssetByAssetId">
        UPDATE t_house_user_asset
        <trim prefix="set" suffixOverrides=",">
            <if test="entity.assetId!=null">asset_id=#{entity.assetId},</if>
            <if test="entity.userId!=null">user_id=#{entity.userId},</if>
            <if test="entity.rentStatus!=null">rent_status=#{entity.rentStatus},</if>
            <if test="entity.createTime!=null">create_time=#{entity.createTime},</if>
            <if test="entity.rentTime!=null">rent_time=#{entity.rentTime},</if>
            <if test="entity.note!=null">note=#{entity.note},</if>

            <if test="true">clash_user_id=#{entity.clashUserId},</if>
            <if test="true">clash_describe=#{entity.clashDescribe},</if>
            <if test="true">clash_certificate=#{entity.clashCertificate},</if>
        </trim>
        where t_house_user_asset.asset_id=#{assetId}
    </update>


    <select id="queryBasicUserAsset" resultType="HouseUserAsset">
        SELECT t_house_user_asset.*
        FROM t_house_user_asset
        WHERE t_house_user_asset.id = #{id};
    </select>


    <!--    查询冲突用户信息-->
    <select id="queryClashUserAsset" resultType="HouseUserAsset">
        SELECT t_house_user_asset.*,
        t_house_property_community.id AS communityId,
        t_house_property_community.community As communityName,
        t_house_property_building.id As buildingId,
        t_house_property_building.area AS buildingArea,
        t_house_property_building.code AS buildingCode,
        t_house_property_building_unit.id AS unitId,
        t_house_design_model.area AS unitArea,
        t_house_design_model.house_type AS houseType,
        t_house_asset.number AS roomNumber,
        t_end_user.name AS userName,
        t_end_user.phone AS userPhone,
        t_end_user.avatar AS userAvatar,
        t_house_property_community.address AS address
        FROM t_house_user_asset
        JOIN t_house_asset ON t_house_asset.id = t_house_user_asset.asset_id
        JOIN t_house_property_building ON t_house_property_building.id = t_house_asset.building_id
        JOIN t_house_property_community
        ON t_house_property_community.id = t_house_property_building.community_id
        JOIN t_house_property_building_unit ON t_house_property_building_unit.id = t_house_asset.unit_id
        JOIN t_house_design_model ON t_house_property_building_unit.design_model_id = t_house_design_model.id
        JOIN t_end_user ON t_end_user.id = t_house_user_asset.user_id
        WHERE t_house_user_asset.clash_user_id IS NOT null
        <if test="search != null and search != ''">
            and (t_house_property_community.address LIKE CONCAT('%',#{search},'%')
            OR t_house_property_community.community LIKE CONCAT('%',#{search},'%')
            OR t_house_property_building.code LIKE CONCAT('%',#{search},'%')
            OR t_house_design_model.house_type LIKE CONCAT('%',#{search},'%')
            OR t_house_asset.floor LIKE CONCAT('%',#{search},'%')
            OR t_house_asset.number LIKE CONCAT('%',#{search},'%'))
        </if>
        <if test="username != null and username != ''">

            and (t_end_user.name LIKE CONCAT('%',#{username},'%')
            OR t_end_user.phone LIKE CONCAT('%',#{username},'%'))
        </if>
    </select>


    <select id="queryHouseUserAssetByAssetId" resultType="HouseUserAsset">
        SELECT t_house_user_asset.*
        FROM t_house_user_asset
        WHERE t_house_user_asset.asset_id = #{assetId};
    </select>


    <!--    查询房东列表-->
    <sql id="LandlordSql">

        t_end_user
        .
        id
        AS userId,
        t_end_user.phone AS userPhone,
        t_end_user.avatar AS userAvatar,
        t_end_user.`name` AS userName,

        t_house_user_note.id as noteId,
        t_house_user_note.note As userNote,
        t_house_user_note.create_time AS createTime,
        t_house_user_note.note_time AS noteTime,

        t_house_user_tag.id As tagId,
        t_house_user_tag.tag_name AS tagName

    </sql>

    <resultMap id="LandlordResultMap" type="HouseUserAssetRecord">

        <id column="userId" property="id"/>
        <association property="userAccount"
                     javaType="com.jfeat.users.account.services.gen.persistence.model.UserAccount">
            <id column="userId" property="id"/>
            <result column="userPhone" property="phone"/>
            <result column="userAvatar" property="avatar"/>
            <result column="userName" property="name"/>
        </association>
        <collection property="userTagList"
                    ofType="com.jfeat.am.module.house.services.gen.persistence.model.HouseUserTag">
            <id column="tagId" property="id"/>
            <result column="tagName" property="tagName"/>
        </collection>

        <collection property="userNoteList"
                    ofType="com.jfeat.am.module.house.services.gen.persistence.model.HouseUserNote">
            <id column="noteId" property="id"/>
            <result column="userNote" property="note"/>
            <result column="noteTime" property="noteTime"/>
            <result column="createTime" property="createTime"/>
        </collection>
    </resultMap>

    <select id="queryLandlordPage" resultMap="LandlordResultMap" parameterType="HouseUserAssetRecord">
        select
        <include refid="LandlordSql"></include>
        FROM t_end_user
        JOIN t_house_user_asset ON t_end_user.id=t_house_user_asset.user_id
        LEFT JOIN t_house_user_tag_relate ON t_house_user_tag_relate.user_id = t_end_user.id
        LEFT JOIN t_house_user_tag ON t_house_user_tag.id = t_house_user_tag_relate.tag_id
        LEFT JOIN t_house_user_note ON t_house_user_note.user_id = t_end_user.id

        WHERE 1=1

        <if test="record.id != null and record.id>0 ">
            AND t_house_user_asset.id LIKE CONCAT('%',#{record.id},'%')
        </if>


        <if test="record.userId != null and record.userId>0 ">
            AND t_house_user_asset.user_id LIKE CONCAT('%',#{record.userId},'%')
        </if>


        <if test="record.assetId != null and record.assetId>0 ">
            AND t_house_user_asset.asset_id LIKE CONCAT('%',#{record.assetId},'%')
        </if>

        <if test="record.note != null and record.note!= ''">
            AND t_house_user_asset.note LIKE CONCAT('%',#{record.note},'%')
        </if>


        <if test="record.createTime != null and record.createTime>0 ">
            AND t_house_user_asset.create_time LIKE CONCAT('%',#{record.createTime},'%')
        </if>


        <if test="startTime != null">
            <![CDATA[AND t_house_user_asset.start_time >= DATE(#{startTime})]]>
        </if>
        <if test="endTime != null">
            <![CDATA[AND t_house_user_asset.end_time <= DATE(#{endTime}]]>
        </if>
        <if test="orgId !=null and orgId>0">
           and t_end_user.org_id=#{orgId}
        </if>

        <if test="search != null and search != ''">

            AND (
            t_end_user.phone LIKE CONCAT('%',#{record.userPhone},'%')
            OR t_end_user.name LIKE CONCAT('%',#{record.username},'%')
            )
        </if>
        order by t_house_user_note.note_time desc
    </select>

    <!--    查询房东有多少房产-->
    <select id="queryLandlordAssetNumber" resultType="HouseUserAssetModel">
        SELECT t_house_user_asset.*, COUNT(*) AS assetNumber
        FROM t_house_user_asset
                 JOIN t_house_asset ON t_house_user_asset.asset_id = t_house_asset.id
                 JOIN t_house_property_building ON t_house_property_building.id = t_house_asset.building_id
                 JOIN t_house_property_community ON t_house_property_community.id = t_house_property_building.community_id
        where 1=1
        <if test="userId!=null and userId>0">
            and t_house_user_asset.userId = #{userId}
        </if>
        <if test="orgId!=null and orgId>0">
            and t_house_property_community.tenant_id=#{orgId}
        </if>
        GROUP BY t_house_user_asset.user_id
    </select>


</mapper>